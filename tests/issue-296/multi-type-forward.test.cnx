// test-c-only
// Issue #404: Forward declarations with multiple external types
// test-execution
// Tests forward declarations when multiple structs and enums are used
// from the same external file.
#include <multi-type-forward-types.cnx>

scope DeviceManager {
    DeviceConfig config;
    DeviceStatus status;

    public void configure(DeviceConfig newConfig) {
        this.config <- newConfig;
    }

    public DeviceConfig getConfig() {
        return this.config;
    }

    public void setStatus(DeviceStatus newStatus) {
        this.status <- newStatus;
    }

    public DeviceStatus getStatus() {
        return this.status;
    }

    public EDeviceState getState() {
        return this.status.state;
    }
}

u32 main() {
    DeviceConfig cfg <- {baudRate: 115200, address: 0x42};
    DeviceManager.configure(cfg);

    DeviceConfig retrievedCfg <- DeviceManager.getConfig();
    if (retrievedCfg.baudRate != 115200) return 1;
    if (retrievedCfg.address != 0x42) return 2;

    DeviceStatus stat <- {state: EDeviceState.STATE_ACTIVE, errorCount: 0, connected: true};
    DeviceManager.setStatus(stat);

    DeviceStatus retrievedStat <- DeviceManager.getStatus();
    if (retrievedStat.state != EDeviceState.STATE_ACTIVE) return 3;
    if (retrievedStat.errorCount != 0) return 4;
    if (retrievedStat.connected != true) return 5;

    EDeviceState state <- DeviceManager.getState();
    if (state != EDeviceState.STATE_ACTIVE) return 6;

    return 0;
}
