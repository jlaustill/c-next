/**
 * Generated by C-Next Transpiler
 * A safer C for embedded systems
 */

// test-execution
// Tests: Computed expressions in loops should NOT be constant-folded
// Issue #200: Only literal true/false should fold to 1/0
//
// Usage: ./test [iterations] [threshold]
//   iterations: number of loop iterations (default: 8)
//   threshold:  comparison threshold for bit1 (default: 3)
// Example: ./test 10 5
#include <stdlib.h>

#include <stdint.h>
#include <stdbool.h>
#include <string.h>

// ADR-044: Overflow helper functions
#include <limits.h>

static inline uint8_t cnx_clamp_add_u8(uint8_t a, uint32_t b) {
    if (b > (uint32_t)(UINT8_MAX - a)) return UINT8_MAX;
    uint8_t result;
    if (__builtin_add_overflow(a, (uint8_t)b, &result)) return UINT8_MAX;
    return result;
}

/* Bitmap: Flags */
/* Fields:
 *   bit0: bit 0 (1 bit)
 *   bit1: bit 1 (1 bit)
 *   bit2: bit 2 (1 bit)
 *   bit3: bit 3 (1 bit)
 *   bit4: bit 4 (1 bit)
 *   bit5: bit 5 (1 bit)
 *   bit6: bit 6 (1 bit)
 *   bit7: bit 7 (1 bit)
 */
typedef uint8_t Flags;

int main(int argc, char *argv[]) {
    Flags f = 0;
    uint8_t count = 0U;
    uint8_t iterations = 8U;
    uint8_t threshold = 3U;
    if (argc > 1) {
        iterations = atoi(argv[1U]);
    }
    if (argc > 2) {
        threshold = atoi(argv[2U]);
    }
    for (uint8_t i = 0; i < iterations; i += 1) {
        f = (f & ~(1 << 0)) | (((i % 2) == 0 ? 1 : 0) << 0);
        f = (f & ~(1 << 1)) | ((i > threshold ? 1 : 0) << 1);
        if (((f >> 0) & 1) == true) {
            f = (f & ~(1 << 2)) | (0 << 2);
        } else {
            f = (f & ~(1 << 2)) | (1 << 2);
        }
        if (((f >> 0) & 1) == true) {
            count = cnx_clamp_add_u8(count, 1U);
        }
    }
    if (((f >> 0) & 1) != false) return 1;
    if (((f >> 1) & 1) != true) return 2;
    if (((f >> 2) & 1) != true) return 3;
    if (count != (iterations / 2)) return 4;
    f = (f & ~(1 << 5)) | (1 << 5);
    f = (f & ~(1 << 6)) | (0 << 6);
    if (((f >> 5) & 1) != true) return 5;
    if (((f >> 6) & 1) != false) return 6;
    return 0;
}
