/**
 * Generated by C-Next Transpiler
 * A safer C for embedded systems
 */

/* test-coverage: 20-atomic-with-clamp */
// Tests: atomic combined with clamp modifier
// Note: Compilation test only - ARM-specific code

#include <stdint.h>
#include <cmsis_gcc.h>

// ADR-044: Overflow helper functions
#include <limits.h>

static inline int8_t cnx_clamp_add_i8(int8_t a, int32_t b) {
    int32_t result = (int32_t)a + b;
    if (result > INT8_MAX) return INT8_MAX;
    if (result < INT8_MIN) return INT8_MIN;
    return (int8_t)result;
}

static inline uint16_t cnx_clamp_add_u16(uint16_t a, uint32_t b) {
    if (b > UINT16_MAX - a) return UINT16_MAX;
    return a + (uint16_t)b;
}

static inline uint32_t cnx_clamp_add_u32(uint32_t a, uint64_t b) {
    if (b > UINT32_MAX - a) return UINT32_MAX;
    return a + (uint32_t)b;
}

static inline uint8_t cnx_clamp_add_u8(uint8_t a, uint32_t b) {
    if (b > UINT8_MAX - a) return UINT8_MAX;
    return a + (uint8_t)b;
}

static inline uint8_t cnx_clamp_sub_u8(uint8_t a, uint32_t b) {
    if (b >= (uint32_t)a) return 0;
    return a - (uint8_t)b;
}

// Atomic clamp variables - saturating arithmetic
volatile uint8_t brightness = 100;

volatile uint16_t volume = 500;

volatile uint32_t counter = 0;

// Signed atomic clamp
volatile int8_t temperature = 0;

volatile int16_t offset = 0;

volatile int32_t position = 0;

void adjustBrightness(uint8_t* delta) {
    do {
        uint8_t __old = __LDREXB(&brightness);
        uint8_t __new = cnx_clamp_add_u8(__old, (*delta));
        if (__STREXB(__new, &brightness) == 0) break;
    } while (1);
}

void decreaseBrightness(uint8_t* delta) {
    do {
        uint8_t __old = __LDREXB(&brightness);
        uint8_t __new = cnx_clamp_sub_u8(__old, (*delta));
        if (__STREXB(__new, &brightness) == 0) break;
    } while (1);
}

void updateVolume(uint16_t* delta) {
    do {
        uint16_t __old = __LDREXH(&volume);
        uint16_t __new = cnx_clamp_add_u16(__old, (*delta));
        if (__STREXH(__new, &volume) == 0) break;
    } while (1);
}

void incrementCounter(void) {
    do {
        uint32_t __old = __LDREXW(&counter);
        uint32_t __new = cnx_clamp_add_u32(__old, 1);
        if (__STREXW(__new, &counter) == 0) break;
    } while (1);
}

void adjustTemperature(int8_t* delta) {
    do {
        int8_t __old = __LDREXB(&temperature);
        int8_t __new = cnx_clamp_add_i8(__old, (*delta));
        if (__STREXB(__new, &temperature) == 0) break;
    } while (1);
}

int main(void) {
    adjustBrightness(&(uint8_t){50});
    decreaseBrightness(&(uint8_t){200});
    updateVolume(&(uint16_t){1000});
    incrementCounter();
    adjustTemperature(&(int8_t){100});
    adjustTemperature(&(int8_t){-100});
}
