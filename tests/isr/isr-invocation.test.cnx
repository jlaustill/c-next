/* test-execution */ // ADR-040: ISR direct invocation
// Tests: invoking ISR through variables (global and local)
// Global to track handler execution
u32 invokeCallCount <- 0;

u32 invokeLastHandler <- 0;

// Handler functions
void invokeHandler1() {
    invokeCallCount +<- 1;
    invokeLastHandler <- 1;
}

void invokeHandler2() {
    invokeCallCount +<- 1;
    invokeLastHandler <- 2;
}

void invokeHandler3() {
    invokeCallCount +<- 1;
    invokeLastHandler <- 3;
}

// Global ISR variable
ISR globalHandler <- invokeHandler1;

u32 main() {
    // Test 1: Invoke global ISR variable
    invokeCallCount <- 0;
    invokeLastHandler <- 0;
    globalHandler();
    if (invokeCallCount != 1) return 1;
    if (invokeLastHandler != 1) return 2;

    // Test 2: Reassign global and invoke
    invokeCallCount <- 0;
    invokeLastHandler <- 0;
    globalHandler <- invokeHandler2;
    globalHandler();
    if (invokeCallCount != 1) return 3;
    if (invokeLastHandler != 2) return 4;

    // Test 3: Local ISR variable
    invokeCallCount <- 0;
    invokeLastHandler <- 0;
    ISR localHandler <- invokeHandler3;
    localHandler();
    if (invokeCallCount != 1) return 5;
    if (invokeLastHandler != 3) return 6;

    // Test 4: Reassign local and invoke
    invokeCallCount <- 0;
    invokeLastHandler <- 0;
    localHandler <- invokeHandler1;
    localHandler();
    if (invokeCallCount != 1) return 7;
    if (invokeLastHandler != 1) return 8;

    // Test 5: Multiple invocations through same variable
    invokeCallCount <- 0;
    localHandler <- invokeHandler2;
    localHandler();
    localHandler();
    localHandler();
    if (invokeCallCount != 3) return 9;
    if (invokeLastHandler != 2) return 10;

    // Test 6: Chain of reassignments
    invokeCallCount <- 0;
    localHandler <- invokeHandler1;
    localHandler(); // count = 1
    localHandler <- invokeHandler2;
    localHandler(); // count = 2
    localHandler <- invokeHandler3;
    localHandler(); // count = 3
    if (invokeCallCount != 3) return 11;
    if (invokeLastHandler != 3) return 12;

    return 0;
}
