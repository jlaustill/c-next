/* test-execution */
// ADR-040: ISR as struct field
// Tests: storing ISR in struct, retrieving and invoking

// Global to track which handler was called
u32 structCallCount <- 0;
u32 structLastHandler <- 0;

// Handler functions
void structHandler1() {
    structCallCount +<- 1;
    structLastHandler <- 1;
}

void structHandler2() {
    structCallCount +<- 1;
    structLastHandler <- 2;
}

void structHandler3() {
    structCallCount +<- 1;
    structLastHandler <- 3;
}

// Struct with ISR fields
struct IsrHolder {
    ISR primary;
    ISR secondary;
}

// Initialize struct with ISR values
void initStructHolder(IsrHolder hld, ISR prim, ISR sec) {
    hld.primary <- prim;
    hld.secondary <- sec;
}

// Invoke ISR from struct field
void invokeStructHolder(IsrHolder hld) {
    hld.primary();
    hld.secondary();
}

u32 main() {
    IsrHolder holder;
    // Initialize both fields before use
    holder.primary <- structHandler1;
    holder.secondary <- structHandler1;

    // Test 1: Assign and invoke primary handler
    structCallCount <- 0;
    structLastHandler <- 0;
    holder.primary <- structHandler1;
    holder.primary();
    if (structCallCount != 1) return 1;
    if (structLastHandler != 1) return 2;

    // Test 2: Assign and invoke secondary handler
    structCallCount <- 0;
    structLastHandler <- 0;
    holder.secondary <- structHandler2;
    holder.secondary();
    if (structCallCount != 1) return 3;
    if (structLastHandler != 2) return 4;

    // Test 3: Initialize via function and invoke both
    structCallCount <- 0;
    structLastHandler <- 0;
    initStructHolder(holder, structHandler1, structHandler3);
    invokeStructHolder(holder);
    if (structCallCount != 2) return 5;
    if (structLastHandler != 3) return 6;  // secondary (structHandler3) called last

    // Test 4: Swap handlers and verify
    structCallCount <- 0;
    holder.primary <- structHandler2;
    holder.secondary <- structHandler1;
    invokeStructHolder(holder);
    if (structCallCount != 2) return 7;
    if (structLastHandler != 1) return 8;  // secondary (structHandler1) called last

    // Test 5: Direct struct field invocation
    structCallCount <- 0;
    structLastHandler <- 0;
    holder.primary <- structHandler3;
    holder.primary();
    if (structCallCount != 1) return 9;
    if (structLastHandler != 3) return 10;

    return 0;
}
