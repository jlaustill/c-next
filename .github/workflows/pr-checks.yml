name: PR Quality Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Prevent concurrent Pages deployments
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  quality-checks:
    name: Code Quality & Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for SonarCloud blame data

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check formatting (Prettier)
        id: prettier
        run: npm run prettier:check
        continue-on-error: true

      - name: Check spelling (cspell)
        id: cspell
        run: npm run cspell:check
        continue-on-error: true

      - name: Check linting (oxlint)
        id: oxlint
        run: npm run oxlint:check
        continue-on-error: true

      - name: Check for dead code (knip)
        id: knip
        run: npx knip
        continue-on-error: true

      - name: Check architecture boundaries (dependency-cruiser)
        id: depcruise
        run: npm run depcruise
        continue-on-error: true

      - name: Generate parser files
        id: generate
        run: npm run antlr:all
        continue-on-error: true

      - name: Check TypeScript types
        id: typecheck
        run: npm run typecheck
        continue-on-error: true

      - name: Run tests
        id: test
        run: npm test
        continue-on-error: true

      - name: Run unit tests with coverage (vitest)
        id: unit
        run: npm run unit -- --coverage
        continue-on-error: true

      - name: Upload coverage artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ./coverage

      - name: Run CLI integration tests
        id: test_cli
        run: npm run test:cli
        continue-on-error: true

      - name: Verify transpiler CLI
        id: cli
        run: |
          # Smoke test: Verify transpiler can process example file
          ./bin/cnext.js examples/teensy4/blink.cnx
          # Check that output was generated
          test -f examples/teensy4/blink.c || exit 1
        continue-on-error: true

      - name: Check grammar coverage (Issue #35)
        id: grammar_coverage
        run: npm run coverage:grammar:check -- --threshold 80
        continue-on-error: true

      - name: Check for uncommitted changes
        id: uncommitted
        run: |
          # Check for any modified, staged, or untracked files
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Uncommitted changes detected after build/test!"
            echo ""
            echo "The following files have changes or are untracked:"
            git status --porcelain
            echo ""
            echo "This usually means generated files need to be committed."
            echo "Run 'npm run antlr:all' and 'npm test' locally, then commit the changes."
            exit 1
          fi
          echo "No uncommitted changes detected."
        continue-on-error: true

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Report results
        if: always()
        run: |
          echo "## Quality Check Results"
          echo ""

          FAILED=0

          if [ "${{ steps.prettier.outcome }}" != "success" ]; then
            echo "❌ Prettier formatting check failed"
            FAILED=1
          else
            echo "✅ Prettier formatting check passed"
          fi

          if [ "${{ steps.cspell.outcome }}" != "success" ]; then
            echo "❌ Spelling check failed"
            FAILED=1
          else
            echo "✅ Spelling check passed"
          fi

          if [ "${{ steps.oxlint.outcome }}" != "success" ]; then
            echo "❌ oxlint check failed"
            FAILED=1
          else
            echo "✅ oxlint check passed"
          fi

          if [ "${{ steps.knip.outcome }}" != "success" ]; then
            echo "❌ Dead code check failed (knip found unused exports/files)"
            FAILED=1
          else
            echo "✅ Dead code check passed"
          fi

          if [ "${{ steps.depcruise.outcome }}" != "success" ]; then
            echo "❌ Architecture boundary check failed (dependency-cruiser)"
            FAILED=1
          else
            echo "✅ Architecture boundary check passed"
          fi

          if [ "${{ steps.generate.outcome }}" != "success" ]; then
            echo "❌ Parser generation failed"
            FAILED=1
          else
            echo "✅ Parser generation passed"
          fi

          if [ "${{ steps.typecheck.outcome }}" != "success" ]; then
            echo "❌ TypeScript type check failed"
            FAILED=1
          else
            echo "✅ TypeScript type check passed"
          fi

          if [ "${{ steps.test.outcome }}" != "success" ]; then
            echo "❌ Tests failed"
            FAILED=1
          else
            echo "✅ Tests passed"
          fi

          if [ "${{ steps.unit.outcome }}" != "success" ]; then
            echo "❌ Unit tests failed"
            FAILED=1
          else
            echo "✅ Unit tests passed"
          fi

          if [ "${{ steps.test_cli.outcome }}" != "success" ]; then
            echo "❌ CLI integration tests failed"
            FAILED=1
          else
            echo "✅ CLI integration tests passed"
          fi

          if [ "${{ steps.cli.outcome }}" != "success" ]; then
            echo "❌ CLI smoke test failed"
            FAILED=1
          else
            echo "✅ CLI smoke test passed"
          fi

          if [ "${{ steps.grammar_coverage.outcome }}" != "success" ]; then
            echo "❌ Grammar coverage check failed (below 80%)"
            FAILED=1
          else
            echo "✅ Grammar coverage check passed"
          fi

          if [ "${{ steps.uncommitted.outcome }}" != "success" ]; then
            echo "❌ Uncommitted changes detected (generated files not committed)"
            FAILED=1
          else
            echo "✅ No uncommitted changes"
          fi

          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "::error::One or more quality checks failed"
            exit 1
          else
            echo "::notice::All quality checks passed!"
          fi

  # Summary job that all checks must pass
  all-checks-passed:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [quality-checks]
    if: always()

    steps:
      - name: Verify all jobs succeeded
        run: |
          if [ "${{ needs.quality-checks.result }}" != "success" ]; then
            echo "Quality checks failed!"
            exit 1
          fi
          echo "✅ All quality checks passed!"

  # Deploy coverage report to GitHub Pages (only on push to main)
  deploy-coverage:
    name: Deploy Coverage to Pages
    runs-on: ubuntu-latest
    needs: [quality-checks]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: ./coverage

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload coverage to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./coverage

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
