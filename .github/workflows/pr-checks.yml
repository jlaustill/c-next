name: PR Quality Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Self-hosted runner for trusted code (your branches, pushes to main)
# GitHub runners for untrusted code (fork PRs)

jobs:
  # ============================================================================
  # STAGE 1 (parallel): Build + Lint
  # ============================================================================
  lint:
    name: Static Analysis
    runs-on: ${{ (github.event_name == 'push' || !github.event.pull_request.head.repo.fork) && 'self-hosted' || 'ubuntu-latest' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Volta
        uses: volta-cli/action@v4

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Check formatting (Prettier)
        id: prettier
        run: npm run prettier:check
        continue-on-error: true

      - name: Check spelling (cspell)
        id: cspell
        run: npm run cspell:check
        continue-on-error: true

      - name: Check linting (oxlint)
        id: oxlint
        run: npm run oxlint:check
        continue-on-error: true

      - name: Check for dead code (knip)
        id: knip
        run: npx knip
        continue-on-error: true

      - name: Check architecture boundaries (dependency-cruiser)
        id: depcruise
        run: npm run depcruise
        continue-on-error: true

      - name: Check test file locations
        id: testlocation
        run: npm run lint:test-location
        continue-on-error: true

      - name: Check code duplication (jscpd)
        id: jscpd
        run: npm run analyze:duplication
        continue-on-error: true

      - name: Report results
        if: always()
        run: |
          FAILED=0
          [ "${{ steps.prettier.outcome }}" != "success" ] && echo "❌ Prettier" && FAILED=1 || echo "✅ Prettier"
          [ "${{ steps.cspell.outcome }}" != "success" ] && echo "❌ Spelling" && FAILED=1 || echo "✅ Spelling"
          [ "${{ steps.oxlint.outcome }}" != "success" ] && echo "❌ oxlint" && FAILED=1 || echo "✅ oxlint"
          [ "${{ steps.knip.outcome }}" != "success" ] && echo "❌ Dead code (knip)" && FAILED=1 || echo "✅ Dead code (knip)"
          [ "${{ steps.depcruise.outcome }}" != "success" ] && echo "❌ Architecture (depcruise)" && FAILED=1 || echo "✅ Architecture (depcruise)"
          [ "${{ steps.testlocation.outcome }}" != "success" ] && echo "❌ Test file locations" && FAILED=1 || echo "✅ Test file locations"
          [ "${{ steps.jscpd.outcome }}" != "success" ] && echo "❌ Code duplication (jscpd)" && FAILED=1 || echo "✅ Code duplication (jscpd)"
          [ $FAILED -eq 1 ] && exit 1 || exit 0

  build:
    name: Build
    runs-on: ${{ (github.event_name == 'push' || !github.event.pull_request.head.repo.fork) && 'self-hosted' || 'ubuntu-latest' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Volta
        uses: volta-cli/action@v4

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Generate parser files
        run: npm run antlr:all

      - name: Build transpiler bundle
        run: npm run build

      - name: Check TypeScript types
        run: npm run typecheck

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          retention-days: 1
          path: |
            dist/
            src/transpiler/logic/parser/grammar/
            src/transpiler/logic/parser/c/grammar/
            src/transpiler/logic/parser/cpp/grammar/

  # ============================================================================
  # STAGE 2a: Transpile tests (generates C/C++ files for validation)
  # ============================================================================
  integration-transpile:
    name: Integration Transpile
    runs-on: ${{ (github.event_name == 'push' || !github.event.pull_request.head.repo.fork) && 'self-hosted' || 'ubuntu-latest' }}
    needs: [build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Volta
        uses: volta-cli/action@v4

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Transpile tests (snapshot comparison only)
        run: npm run integration:transpile

      - name: Upload generated test files
        uses: actions/upload-artifact@v4
        with:
          name: generated-test-files
          retention-days: 1
          path: |
            tests/**/*.test.c
            tests/**/*.test.cpp
            tests/**/*.test.h

  # ============================================================================
  # STAGE 2b (parallel): Execute tests + other test suites
  # ============================================================================
  integration-execute:
    name: Integration Execute
    runs-on: ${{ (github.event_name == 'push' || !github.event.pull_request.head.repo.fork) && 'self-hosted' || 'ubuntu-latest' }}
    needs: [integration-transpile]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Volta
        uses: volta-cli/action@v4

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Download generated test files
        uses: actions/download-artifact@v4
        with:
          name: generated-test-files
          path: tests

      - name: Execute tests (compile + run)
        run: npm run integration:execute

  unit-tests:
    name: Unit Tests
    runs-on: ${{ (github.event_name == 'push' || !github.event.pull_request.head.repo.fork) && 'self-hosted' || 'ubuntu-latest' }}
    needs: [build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for SonarCloud blame data

      - name: Setup Volta
        uses: volta-cli/action@v4

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run unit tests with coverage
        run: npm run unit -- --coverage

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ./coverage

  cli-tests:
    name: CLI Tests
    runs-on: ${{ (github.event_name == 'push' || !github.event.pull_request.head.repo.fork) && 'self-hosted' || 'ubuntu-latest' }}
    needs: [build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Volta
        uses: volta-cli/action@v4

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Run CLI integration tests
        run: npm run test:cli

      - name: Verify transpiler CLI
        run: |
          node dist/index.js examples/teensy4/blink.cnx
          test -f examples/teensy4/blink.c || exit 1

  grammar-coverage:
    name: Grammar Coverage
    runs-on: ${{ (github.event_name == 'push' || !github.event.pull_request.head.repo.fork) && 'self-hosted' || 'ubuntu-latest' }}
    needs: [build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Volta
        uses: volta-cli/action@v4

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Check grammar coverage
        run: npm run coverage:grammar:check -- --threshold 80

  verify-clean:
    name: Verify Clean
    runs-on: ${{ (github.event_name == 'push' || !github.event.pull_request.head.repo.fork) && 'self-hosted' || 'ubuntu-latest' }}
    needs: [integration-transpile]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output

      - name: Download generated test files
        uses: actions/download-artifact@v4
        with:
          name: generated-test-files
          path: tests

      - name: Check for uncommitted changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Uncommitted changes detected!"
            git status --porcelain
            echo ""
            echo "Run 'npm run antlr:all' and 'npm test' locally, then commit."
            exit 1
          fi
          echo "✅ No uncommitted changes"

  # ============================================================================
  # STAGE 3 (parallel): Analysis that needs generated files
  # ============================================================================
  c-validation:
    name: C Static Analysis (${{ matrix.tool }})
    runs-on: ${{ (github.event_name == 'push' || !github.event.pull_request.head.repo.fork) && 'self-hosted' || 'ubuntu-latest' }}
    needs: [integration-transpile]
    # Advisory: pre-existing MISRA violations exist; don't block PR merges
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        # Note: 'misra' is a cppcheck addon, not a standalone tool
        # batch-validate.mjs handles this dependency automatically
        tool: [cppcheck, clang-tidy, misra, flawfinder]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Volta
        uses: volta-cli/action@v4

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: Install dependencies
        run: npm ci

      - name: Install C analysis tools
        if: runner.environment == 'github-hosted'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq cppcheck clang-tidy flawfinder

      - name: Download generated test files
        uses: actions/download-artifact@v4
        with:
          name: generated-test-files
          path: tests

      - name: Run validation
        env:
          TOOL: ${{ matrix.tool }}
        run: npm run validate:c -- --tool "$TOOL"

  sonar:
    name: SonarCloud
    runs-on: ${{ (github.event_name == 'push' || !github.event.pull_request.head.repo.fork) && 'self-hosted' || 'ubuntu-latest' }}
    needs: [unit-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: ./coverage

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ============================================================================
  # FINAL: All checks must pass
  # ============================================================================
  all-checks-passed:
    name: All Checks Passed
    runs-on: ${{ (github.event_name == 'push' || !github.event.pull_request.head.repo.fork) && 'self-hosted' || 'ubuntu-latest' }}
    needs:
      [
        lint,
        build,
        integration-transpile,
        integration-execute,
        unit-tests,
        cli-tests,
        grammar-coverage,
        verify-clean,
        c-validation,
        sonar,
      ]
    if: always()

    steps:
      - name: Verify all jobs succeeded
        run: |
          echo "## Results"
          FAILED=0
          [ "${{ needs.lint.result }}" != "success" ] && echo "❌ Static Analysis" && FAILED=1 || echo "✅ Static Analysis"
          [ "${{ needs.build.result }}" != "success" ] && echo "❌ Build" && FAILED=1 || echo "✅ Build"
          [ "${{ needs.integration-transpile.result }}" != "success" ] && echo "❌ Integration Transpile" && FAILED=1 || echo "✅ Integration Transpile"
          [ "${{ needs.integration-execute.result }}" != "success" ] && echo "❌ Integration Execute" && FAILED=1 || echo "✅ Integration Execute"
          [ "${{ needs.unit-tests.result }}" != "success" ] && echo "❌ Unit Tests" && FAILED=1 || echo "✅ Unit Tests"
          [ "${{ needs.cli-tests.result }}" != "success" ] && echo "❌ CLI Tests" && FAILED=1 || echo "✅ CLI Tests"
          [ "${{ needs.grammar-coverage.result }}" != "success" ] && echo "❌ Grammar Coverage" && FAILED=1 || echo "✅ Grammar Coverage"
          [ "${{ needs.verify-clean.result }}" != "success" ] && echo "❌ Verify Clean" && FAILED=1 || echo "✅ Verify Clean"
          [ "${{ needs.c-validation.result }}" != "success" ] && echo "⚠️ C Static Analysis (advisory)" || echo "✅ C Static Analysis"
          [ "${{ needs.sonar.result }}" != "success" ] && echo "❌ SonarCloud" && FAILED=1 || echo "✅ SonarCloud"
          [ $FAILED -eq 1 ] && exit 1 || echo "::notice::All checks passed!"

  # ============================================================================
  # DEPLOY: Coverage to GitHub Pages (only on push to main)
  # ============================================================================
  deploy-coverage:
    name: Deploy Coverage
    runs-on: ${{ (github.event_name == 'push' || !github.event.pull_request.head.repo.fork) && 'self-hosted' || 'ubuntu-latest' }}
    needs: [unit-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    # Prevent concurrent Pages deployments
    concurrency:
      group: "pages"
      cancel-in-progress: false
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: ./pages/coverage

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload coverage to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./pages

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
