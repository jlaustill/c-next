// test-execution
// Tests: .length property on nested C header struct members
// Regression test for issue #103/#196 - .length on nested struct member access

#include "../../include/NestedTestConfig.h"

u32 main() {
    OuterConfig config;
    // Initialize fields to satisfy uninitialized variable check
    config.directField <- 0;
    config.single.byteField <- 0;
    config.single.shortField <- 0;
    config.single.intField <- 0;
    config.single.floatField <- 0.0;
    for (u32 init <- 0; init < 4; init +<- 1) {
        config.array[init].byteField <- 0;
        config.array[init].shortField <- 0;
        config.array[init].intField <- 0;
        config.array[init].floatField <- 0.0;
    }

    // LEVEL 1: Direct struct field (baseline)
    if (config.directField.length != 32) return 1;

    // LEVEL 2: Nested struct field
    if (config.single.byteField.length != 8) return 2;
    if (config.single.shortField.length != 16) return 3;
    if (config.single.intField.length != 32) return 4;
    if (config.single.floatField.length != 32) return 5;

    // LEVEL 3: Array of nested structs - constant index
    if (config.array[0].byteField.length != 8) return 6;
    if (config.array[0].shortField.length != 16) return 7;
    if (config.array[1].intField.length != 32) return 8;
    if (config.array[2].floatField.length != 32) return 9;

    // LEVEL 3: Array of nested structs - loop variable index
    for (u32 i <- 0; i < 4; i +<- 1) {
        if (config.array[i].intField.length != 32) return 10;
        if (config.array[i].byteField.length != 8) return 11;
    }

    // Test 3-level deep nesting (DeepConfig -> OuterConfig -> InnerConfig)
    DeepConfig deep;
    deep.timestamp <- 0;
    deep.outer.directField <- 0;
    deep.outer.single.byteField <- 0;
    deep.outer.single.shortField <- 0;
    deep.outer.single.intField <- 0;
    deep.outer.single.floatField <- 0.0;
    for (u32 k <- 0; k < 4; k +<- 1) {
        deep.outer.array[k].shortField <- 0;
    }

    if (deep.outer.single.byteField.length != 8) return 12;
    if (deep.outer.single.shortField.length != 16) return 13;
    if (deep.outer.single.intField.length != 32) return 14;
    if (deep.outer.single.floatField.length != 32) return 15;
    if (deep.outer.array[0].shortField.length != 16) return 16;
    if (deep.outer.directField.length != 32) return 17;
    if (deep.timestamp.length != 64) return 18;

    // Test byte calculation from nested struct (common serialization pattern)
    u32 bytes <- config.single.intField.length / 8;
    if (bytes != 4) return 19;

    // Test expression with multiple nested .length values
    u32 total <- config.single.byteField.length + config.single.shortField.length;
    if (total != 24) return 20;  // 8 + 16 = 24

    // Test nested .length in loop bounds (edge case)
    u32 bitSum <- 0;
    for (u32 j <- 0; j < 4; j +<- 1) {
        bitSum +<- config.array[j].byteField.length;
    }
    if (bitSum != 32) return 21;  // 4 * 8 = 32

    return 0;  // All tests passed
}
