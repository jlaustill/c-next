/**
 * Generated by C-Next Transpiler
 * A safer C for embedded systems
 */

#include "reassign-call-in-conditional.test.h"

#include <stdint.h>
#include <stdbool.h>

// test-execution
// Tests: Issue #565 - const inference fails for reassignment inside conditionals
// When a variable is declared first and later reassigned with a modifying call
// inside a conditional, the const analyzer should still detect the modification.
// A scope with a method that modifies its config parameter
/* Scope: CommandHandler */

uint8_t CommandHandler_setValue(Config& cfg, uint32_t val) {
    cfg.value = val;
    return 0;
}

uint8_t CommandHandler_enable(Config& cfg) {
    cfg.enabled = true;
    return 0;
}

// BUG: Declaration first, reassignment with modifying call inside if
// This pattern triggers issue #565 - the reassignment's RHS isn't walked for calls
void handleEnableSpn(Config& config) {
    bool enable = true;
    uint8_t errorCode = 0U;
    if (enable) {
        errorCode = CommandHandler_setValue(config, 42U);
    } else {
        errorCode = CommandHandler_setValue(config, 0U);
    }
}

// Variant: reassignment inside else branch
void handleElseBranch(Config& config) {
    bool enable = false;
    uint8_t errorCode = 0U;
    if (enable) {
        errorCode = 1U;
    } else {
        errorCode = CommandHandler_enable(config);
    }
}

// Variant: reassignment inside while loop
void handleWhileLoop(Config& config) {
    uint8_t errorCode = 0U;
    uint32_t count = 0U;
    while (count < 1) {
        errorCode = CommandHandler_setValue(config, 100U);
        count = count + 1U;
    }
}

// Variant: reassignment inside for loop
void handleForLoop(Config& config) {
    uint8_t errorCode = 0U;
    for (uint32_t i = 0; i < 1; i = i + 1) {
        errorCode = CommandHandler_setValue(config, 200U);
    }
}

// Control case: declaration with modifying call (this already works)
void handleDeclaration(Config& config) {
    bool enable = true;
    if (enable) {
        uint8_t errorCode = CommandHandler_setValue(config, 42U);
    }
}

// Control case: top-level reassignment (outside conditional)
void handleTopLevel(Config& config) {
    uint8_t errorCode = 0U;
    errorCode = CommandHandler_setValue(config, 300U);
}

int main(void) {
    Config cfg = {0};
    cfg.value = 0U;
    cfg.enabled = false;
    handleEnableSpn(cfg);
    if (cfg.value != 42) return 1;
    cfg.value = 0U;
    cfg.enabled = false;
    handleElseBranch(cfg);
    if (cfg.enabled != true) return 2;
    cfg.value = 0U;
    cfg.enabled = false;
    handleWhileLoop(cfg);
    if (cfg.value != 100) return 3;
    cfg.value = 0U;
    handleForLoop(cfg);
    if (cfg.value != 200) return 4;
    cfg.value = 0U;
    handleDeclaration(cfg);
    if (cfg.value != 42) return 5;
    cfg.value = 0U;
    handleTopLevel(cfg);
    if (cfg.value != 300) return 6;
    return 0;
}
