/**
 * Generated by C-Next Transpiler
 * A safer C for embedded systems
 */

#include <stdint.h>
#include <stdbool.h>

// test-coverage: 12-bitfield-members
// Tests: Register using bitmap types as bitfield members
// This tests the pattern of defining structured bitfields via bitmap types
// 8-bit control bitmap
/* Bitmap: UARTControl */
/* Fields:
 *   Enable: bit 0 (1 bit)
 *   TxEnable: bit 1 (1 bit)
 *   RxEnable: bit 2 (1 bit)
 *   Parity: bit 3 (1 bit)
 *   StopBits: bit 4 (1 bit)
 *   DataBits: bits 5-6 (2 bits)
 *   Reserved: bit 7 (1 bit)
 */
typedef uint8_t UARTControl;

// 8-bit status bitmap
/* Bitmap: UARTStatus */
/* Fields:
 *   TxReady: bit 0 (1 bit)
 *   RxReady: bit 1 (1 bit)
 *   TxEmpty: bit 2 (1 bit)
 *   RxFull: bit 3 (1 bit)
 *   OverrunErr: bit 4 (1 bit)
 *   FrameErr: bit 5 (1 bit)
 *   ParityErr: bit 6 (1 bit)
 *   Busy: bit 7 (1 bit)
 */
typedef uint8_t UARTStatus;

// 16-bit configuration bitmap
/* Bitmap: TimerConfig */
/* Fields:
 *   Enable: bit 0 (1 bit)
 *   OneShot: bit 1 (1 bit)
 *   AutoReload: bit 2 (1 bit)
 *   Interrupt: bit 3 (1 bit)
 *   Prescaler: bits 4-11 (8 bits)
 *   Reserved: bits 12-15 (4 bits)
 */
typedef uint16_t TimerConfig;

// Register using multiple bitmap types as members
/* Register: UART @ 0x40010000 */
#define UART_CTRL (*(volatile UARTControl*)(0x40010000 + 0x00))
#define UART_STATUS (*(volatile UARTStatus const *)(0x40010000 + 0x04))
#define UART_DATA (*(volatile uint8_t*)(0x40010000 + 0x08))

/* Register: TIMER @ 0x40020000 */
#define TIMER_CONFIG (*(volatile TimerConfig*)(0x40020000 + 0x00))
#define TIMER_COUNT (*(volatile uint32_t const *)(0x40020000 + 0x04))
#define TIMER_RELOAD (*(volatile uint32_t*)(0x40020000 + 0x08))

void configureUART(void) {
    UART_CTRL = (UART_CTRL & ~(1 << 0)) | (1 << 0);
    UART_CTRL = (UART_CTRL & ~(1 << 1)) | (1 << 1);
    UART_CTRL = (UART_CTRL & ~(1 << 2)) | (1 << 2);
    UART_CTRL = (UART_CTRL & ~(0x3 << 5)) | ((3 & 0x3) << 5);
}

bool isUARTReady(void) {
    return ((UART_STATUS >> 0) & 1);
}

void configureTimer(const uint8_t* prescale) {
    TIMER_CONFIG = (TIMER_CONFIG & ~(1 << 0)) | (0 << 0);
    TIMER_CONFIG = (TIMER_CONFIG & ~(0xFF << 4)) | (((*prescale) & 0xFF) << 4);
    TIMER_CONFIG = (TIMER_CONFIG & ~(1 << 2)) | (1 << 2);
    TIMER_CONFIG = (TIMER_CONFIG & ~(1 << 3)) | (1 << 3);
    TIMER_CONFIG = (TIMER_CONFIG & ~(1 << 0)) | (1 << 0);
}

int main(void) {
    configureUART();
    bool uartReady = isUARTReady();
    if (uartReady) {
        UART_DATA = 0x55;
    }
    configureTimer(&(uint8_t){100});
    bool hasError = ((UART_STATUS >> 4) & 1);
    bool isBusy = ((UART_STATUS >> 7) & 1);
    uint8_t dataBits = ((UART_CTRL >> 5) & 0x3);
}
