/**
 * Generated by C-Next Transpiler from: issue-937.test.cnx
 * A safer C for embedded systems
 */

#include "issue-937.test.h"

// test-execution
// test-c-only
// Bug #937: Callback params dereferenced when forwarded to global. calls
// When a scope function matches a callback typedef, its promoted pointer params
// should be passed directly to global. function calls, not dereferenced.
#include "widget.h"

#include <stdint.h>

/* Scope: Port */

static void Port_my_flush(widget_t* w, const rect_t* area, uint8_t* buf) {
    int32_t x2 = area->x2 + 1;
    int32_t y2 = area->y2 + 1;
    draw_bitmap(0, area->x1, area->y1, x2, y2, buf);
    flush_ready(w);
}

void Port_init(void) {
    register_flush(Port_my_flush);
}

int main(void) {
    Port_init();
    rect_t r = (rect_t){ .x1 = 10, .y1 = 20, .x2 = 100, .y2 = 200 };
    uint8_t buffer[4] = {0xAAU, 0xBBU, 0xCCU, 0xDDU};
    widget_t dummy_widget = (widget_t){ .dummy = 42 };
    int32_t invoked = invoke_registered_cb(&dummy_widget, &r, buffer);
    if (invoked == 0) return 1;
    if (last_x1 != 10) return 2;
    if (last_y1 != 20) return 3;
    if (last_x2 != 101) return 4;
    if (last_y2 != 201) return 5;
    if (last_data != buffer) return 6;
    if (last_widget != &dummy_widget) return 7;
    return 0;
}
