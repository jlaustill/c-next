// Issue #332: Missing & for C-Next structs passed to external pointer parameters
// When calling external C++ functions that expect pointer parameters,
// the transpiler should add & for BOTH:
// - Structs from C headers (Issue332AppConfig from .h) - this WORKS
// - Structs from C-Next files (Issue332AppData from .cnx) - this was BROKEN

#include <issue-332-cnx-types.cnx>
#include "issue-332-c-header-types.h"
#include "issue-332-external-processor.hpp"

scope Issue332Storage {
    Issue332AppData appData;      // From C-Next .cnx file
    Issue332AppConfig appConfig;  // From C .h file

    public void setup() {
        // Initialize C header struct
        this.appConfig.setting <- 100;
        this.appConfig.flags <- 5;

        // Initialize C-Next struct
        this.appData.value <- 10.5;
        this.appData.count <- 0;
    }

    public void processAll() {
        // Call external function with C header struct pointer
        // This should add & automatically: &Issue332Storage_appConfig
        global.Issue332DataProcessor.processConfig(this.appConfig);

        // Call external function with C-Next struct pointer
        // BUG: This was NOT adding & automatically - should be: &Issue332Storage_appData
        global.Issue332DataProcessor.processData(this.appData);
    }

    public void initFromConfig() {
        // Both struct types in same call
        // C header struct: should add &Issue332Storage_appConfig
        // C-Next struct: should add &Issue332Storage_appData (BUG: was missing)
        global.Issue332DataProcessor.initialize(this.appConfig, this.appData);
    }
}

void main() {
    Issue332Storage.setup();
    Issue332Storage.processAll();
}
