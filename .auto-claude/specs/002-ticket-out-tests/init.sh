#!/bin/bash

# Auto-Build Environment Setup
# Spec: 002-ticket-out-tests (Create Tickets for Uncovered Tests)
# Generated by Planner Agent

set -e

echo "========================================"
echo "Ticket Creation Environment Setup"
echo "========================================"
echo ""
echo "Project: C-Next Language Coverage Tickets"
echo "Type: Ticket creation (no services to start)"
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ============================================
# VERIFY PROJECT STRUCTURE
# ============================================

echo "Verifying project structure..."

# Check coverage.md exists
if [ -f "coverage.md" ]; then
    echo -e "${GREEN}[OK]${NC} coverage.md found"
    UNCOVERED_COUNT=$(grep -c '\[ \]' coverage.md || echo "0")
    echo "     Uncovered test cases: $UNCOVERED_COUNT"
else
    echo -e "${RED}[ERROR]${NC} coverage.md not found"
    exit 1
fi

# Check tests directory
if [ -d "tests" ]; then
    TEST_COUNT=$(find tests -name "*.cnx" | wc -l)
    echo -e "${GREEN}[OK]${NC} tests/ directory found ($TEST_COUNT existing tests)"
else
    echo -e "${RED}[ERROR]${NC} tests/ directory not found"
    exit 1
fi

# ============================================
# CREATE TICKET DIRECTORIES (if needed)
# ============================================

echo ""
echo "Setting up ticket directories..."

mkdir -p .auto-claude/tickets/high-priority
mkdir -p .auto-claude/tickets/medium-priority
mkdir -p .auto-claude/tickets/low-priority

echo -e "${GREEN}[OK]${NC} Ticket directories created"

# ============================================
# VERIFY NPM/NODE (for potential future runs)
# ============================================

echo ""
echo "Verifying Node.js environment..."

if command -v node &> /dev/null; then
    NODE_VERSION=$(node -v)
    echo -e "${GREEN}[OK]${NC} Node.js installed: $NODE_VERSION"
else
    echo -e "${YELLOW}[WARN]${NC} Node.js not found (not required for ticket creation)"
fi

if command -v npm &> /dev/null; then
    NPM_VERSION=$(npm -v)
    echo -e "${GREEN}[OK]${NC} npm installed: $NPM_VERSION"
else
    echo -e "${YELLOW}[WARN]${NC} npm not found (not required for ticket creation)"
fi

# ============================================
# SUMMARY
# ============================================

echo ""
echo "========================================"
echo "Environment Ready!"
echo "========================================"
echo ""
echo "This is a TICKET CREATION task."
echo "No services need to be started."
echo ""
echo "The coder agent will:"
echo "  1. Create ~265 ticket files in .auto-claude/tickets/"
echo "  2. Organize by priority (high/medium/low)"
echo "  3. Each ticket covers one uncovered test from coverage.md"
echo ""
echo "To start the build, run:"
echo "  source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 002 --parallel 3"
echo ""
