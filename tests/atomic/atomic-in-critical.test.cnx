/* test-coverage: 20-atomic-in-critical */ // Tests: atomic operations inside critical sections
// Note: Compilation test only - ARM-specific code
#pragma target teensy41

atomic u32 sharedCounter <- 0;

atomic wrap u16 sequence <- 0;

u8 buffer[64];

u32 writeIdx <- 0;

// Atomic operation within critical section
void criticalUpdate() {
    critical {
        sharedCounter +<- 1;
        sequence +<- 1;
    }
}

// Mixed atomic and non-atomic in critical
void enqueueWithCount(u8 data) {
    critical {
        buffer[writeIdx] <- data;
        writeIdx +<- 1;
        sharedCounter +<- 1; // Track total enqueues
    }
}

// Multiple atomic operations in critical
void batchUpdate(u32 delta) {
    critical {
        sharedCounter +<- delta;
        sequence +<- 1;
    }
}

// Read and write atomic in critical
void conditionalIncrement() {
    critical {
        if (sharedCounter < 1000) {
            sharedCounter +<- 1;
        }
    }
}

void main() {
    criticalUpdate();
    enqueueWithCount(0xAB);
    batchUpdate(10);
    conditionalIncrement();
}
