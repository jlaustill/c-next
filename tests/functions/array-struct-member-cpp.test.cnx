// tests/functions/array-struct-member-cpp.test.cnx
// test-execution
// Tests: Issue #256 - array-of-structs member passing in C++ mode
// When passing arr[i].member to u8 parameter, must generate temp variable
// because bool* and enum* cannot convert to uint8_t* in C++

#include "array-struct-member-cpp.h"

// Array of external C structs with bool/enum members
SensorReading[4] sensors;

u32 process(u32 crc, u8 byte) {
    return crc ^ byte;
}

u32 testArrayStructMembers() {
    u32 crc <- 0;

    // Initialize array element
    sensors[0].active <- true;
    sensors[0].sensorType <- SENSOR_PRESSURE;
    sensors[0].status <- STATUS_ON;
    sensors[0].value <- 42;

    // Each of these should generate temp with static_cast:
    // uint8_t _cnx_tmp_N = static_cast<uint8_t>(sensors[0].active);
    // NOT: &sensors[0].active which gives bool* instead of uint8_t*
    crc <- process(crc, sensors[0].active);      // bool -> u8
    crc <- process(crc, sensors[0].sensorType);  // ESensorType -> u8
    crc <- process(crc, sensors[0].status);      // EStatus -> u8
    crc <- process(crc, sensors[0].value);       // u8 -> u8

    return crc;
}

u32 testMultipleIndices() {
    u32 crc <- 0;

    // Test with different array indices
    sensors[1].active <- false;
    sensors[1].sensorType <- SENSOR_HUMIDITY;
    sensors[2].status <- STATUS_ERROR;
    sensors[3].value <- 100;

    crc <- process(crc, sensors[1].active);      // index 1
    crc <- process(crc, sensors[1].sensorType);  // index 1
    crc <- process(crc, sensors[2].status);      // index 2
    crc <- process(crc, sensors[3].value);       // index 3

    return crc;
}

u32 main() {
    // Test 1: Array struct member passing
    // Expected: 0 ^ 1 ^ 1 ^ 1 ^ 42 = 43
    u32 result1 <- testArrayStructMembers();
    if (result1 != 43) return 1;

    // Test 2: Multiple indices
    // Expected: 0 ^ 0 ^ 2 ^ 2 ^ 100 = 100
    u32 result2 <- testMultipleIndices();
    if (result2 != 100) return 2;

    return 0;
}
