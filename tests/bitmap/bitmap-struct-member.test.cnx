/* test-coverage: 11-bitmap-struct-member */
/* test-execution */
// Tests: Bitmap as struct member

bitmap8 Flags {
    Active,       // bit 0
    Ready,        // bit 1
    Error,        // bit 2
    Mode[5]       // bits 3-7
}

bitmap16 Status {
    Running,          // bit 0
    Paused,           // bit 1
    Complete,         // bit 2
    Reserved[5],      // bits 3-7
    Progress[8]       // bits 8-15
}

struct Device {
    u32 id;
    Flags flags;
    Status status;
    u32 value;
}

struct Controller {
    Flags controlFlags;
    u32 counter;
}

Device device;
Controller ctrl;

u32 main() {
    // Initialize device
    device.id <- 12345;
    device.value <- 100;

    // Test bitmap member write - single bits
    device.flags.Active <- true;
    device.flags.Ready <- true;
    device.flags.Error <- false;

    if (device.flags.Active != true) return 1;
    if (device.flags.Ready != true) return 2;
    if (device.flags.Error != false) return 3;

    // Test bitmap member write - multi-bit field
    device.flags.Mode <- 15;
    if (device.flags.Mode != 15) return 4;

    // Test 16-bit bitmap member
    device.status.Running <- true;
    device.status.Paused <- false;
    device.status.Complete <- false;
    device.status.Progress <- 50;

    if (device.status.Running != true) return 5;
    if (device.status.Paused != false) return 6;
    if (device.status.Progress != 50) return 7;

    // Verify other struct members unchanged
    if (device.id != 12345) return 8;
    if (device.value != 100) return 9;

    // Test second struct with bitmap
    ctrl.counter <- 999;
    ctrl.controlFlags.Active <- true;
    ctrl.controlFlags.Mode <- 7;

    if (ctrl.controlFlags.Active != true) return 10;
    if (ctrl.controlFlags.Mode != 7) return 11;
    if (ctrl.counter != 999) return 12;

    // Update progress
    device.status.Progress <- 100;
    device.status.Complete <- true;

    if (device.status.Progress != 100) return 13;
    if (device.status.Complete != true) return 14;
    if (device.status.Running != true) return 15;  // Unchanged

    // Read bitmap fields into variables
    bool isActive <- device.flags.Active;
    if (isActive != true) return 16;

    u8 progress <- device.status.Progress;
    if (progress != 100) return 17;

    u8 mode <- device.flags.Mode;
    if (mode != 15) return 18;

    return 0;
}
